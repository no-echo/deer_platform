# 林麝养殖交流分享平台技术实现方案

## 1. 技术架构总览

### 1.1 整体架构

┌─────────────────────────────────────────────────────────────┐
│                    前端层 (Vue 3)                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │   PC Web    │ │  Mobile H5  │ │  管理后台    │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────┐
│                    网关层 (Nginx)                            │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │  负载均衡    │ │   SSL终结   │ │   静态资源   │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────┐
│                  应用层 (Spring Boot)                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │  用户服务    │ │  内容服务    │ │  管理服务    │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────┘
│
▼
┌─────────────────────────────────────────────────────────────┐
│                    数据层                                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │   MySQL     │ │    Redis    │ │  阿里云OSS   │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
└─────────────────────────────────────────────────────────────┘


### 1.2 技术栈选型

#### 前端技术栈
- **框架**: Vue 3.3+ (Composition API)
- **UI组件库**: Element Plus 2.4+
- **状态管理**: Pinia
- **路由**: Vue Router 4
- **HTTP客户端**: Axios
- **构建工具**: Vite 4
- **CSS预处理器**: SCSS
- **移动端适配**: Viewport + Flexible

#### 后端技术栈
- **框架**: Spring Boot 2.7.x
- **安全**: Spring Security + JWT
- **数据访问**: MyBatis Plus 3.5+
- **数据库**: MySQL 8.0
- **缓存**: Redis 7.0
- **文件存储**: 阿里云OSS
- **邮件服务**: Spring Mail
- **API文档**: Swagger 3
- **日志**: Logback + ELK

#### 运维技术栈
- **容器化**: Docker + Docker Compose
- **CI/CD**: Jenkins / GitHub Actions
- **监控**: Prometheus + Grafana
- **日志收集**: ELK Stack
- **云服务**: 阿里云 / 腾讯云

## 2. 数据库设计

### 2.1 数据库表结构

#### 用户相关表
```sql
-- 用户表
CREATE TABLE `users` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `email` varchar(100) NOT NULL COMMENT '邮箱',
  `password` varchar(255) NOT NULL COMMENT '密码(加密)',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `bio` text COMMENT '个人简介',
  `role` enum('USER','ADMIN','VIP') DEFAULT 'USER' COMMENT '用户角色',
  `status` enum('ACTIVE','BANNED','PENDING') DEFAULT 'PENDING' COMMENT '账户状态',
  `email_verified` tinyint(1) DEFAULT '0' COMMENT '邮箱是否验证',
  `vip_expire_time` datetime DEFAULT NULL COMMENT 'VIP过期时间',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_email` (`email`),
  KEY `idx_status` (`status`),
  KEY `idx_role` (`role`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- 邮箱验证码表
CREATE TABLE `email_codes` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `email` varchar(100) NOT NULL COMMENT '邮箱',
  `code` varchar(6) NOT NULL COMMENT '验证码',
  `type` enum('REGISTER','RESET_PASSWORD') NOT NULL COMMENT '验证码类型',
  `used` tinyint(1) DEFAULT '0' COMMENT '是否已使用',
  `expire_time` datetime NOT NULL COMMENT '过期时间',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_email_type` (`email`, `type`),
  KEY `idx_expire_time` (`expire_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='邮箱验证码表';
```

#### 内容相关表
```sql
-- 分类表
CREATE TABLE `categories` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL COMMENT '分类名称',
  `slug` varchar(50) NOT NULL COMMENT '分类标识',
  `description` text COMMENT '分类描述',
  `icon` varchar(255) DEFAULT NULL COMMENT '分类图标',
  `sort_order` int DEFAULT '0' COMMENT '排序',
  `status` enum('ACTIVE','INACTIVE') DEFAULT 'ACTIVE',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_slug` (`slug`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='分类表';

-- 帖子表
CREATE TABLE `posts` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '作者ID',
  `category_id` int NOT NULL COMMENT '分类ID',
  `title` varchar(200) NOT NULL COMMENT '标题',
  `content` longtext NOT NULL COMMENT '内容',
  `summary` varchar(500) DEFAULT NULL COMMENT '摘要',
  `cover_image` varchar(255) DEFAULT NULL COMMENT '封面图',
  `images` json DEFAULT NULL COMMENT '图片列表',
  `tags` varchar(500) DEFAULT NULL COMMENT '标签(逗号分隔)',
  `view_count` int DEFAULT '0' COMMENT '浏览量',
  `like_count` int DEFAULT '0' COMMENT '点赞数',
  `comment_count` int DEFAULT '0' COMMENT '评论数',
  `collect_count` int DEFAULT '0' COMMENT '收藏数',
  `status` enum('DRAFT','PENDING','PUBLISHED','REJECTED') DEFAULT 'PENDING' COMMENT '状态',
  `is_top` tinyint(1) DEFAULT '0' COMMENT '是否置顶',
  `is_featured` tinyint(1) DEFAULT '0' COMMENT '是否精选',
  `published_at` datetime DEFAULT NULL COMMENT '发布时间',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_status` (`status`),
  KEY `idx_published_at` (`published_at`),
  KEY `idx_is_top_featured` (`is_top`, `is_featured`),
  FULLTEXT KEY `ft_title_content` (`title`, `content`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='帖子表';

-- 评论表
CREATE TABLE `comments` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `post_id` bigint NOT NULL COMMENT '帖子ID',
  `user_id` bigint NOT NULL COMMENT '评论者ID',
  `parent_id` bigint DEFAULT NULL COMMENT '父评论ID',
  `content` text NOT NULL COMMENT '评论内容',
  `like_count` int DEFAULT '0' COMMENT '点赞数',
  `status` enum('PENDING','APPROVED','REJECTED') DEFAULT 'PENDING' COMMENT '审核状态',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_post_id` (`post_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评论表';
```

#### 互动相关表
```sql
-- 点赞表
CREATE TABLE `likes` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `target_type` enum('POST','COMMENT') NOT NULL COMMENT '目标类型',
  `target_id` bigint NOT NULL COMMENT '目标ID',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_target` (`user_id`, `target_type`, `target_id`),
  KEY `idx_target` (`target_type`, `target_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='点赞表';

-- 收藏表
CREATE TABLE `collections` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `post_id` bigint NOT NULL COMMENT '帖子ID',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_post` (`user_id`, `post_id`),
  KEY `idx_post_id` (`post_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='收藏表';
```

### 2.2 Redis缓存设计

user:info:{userId}              # 用户信息缓存
user:token:{token}              # JWT Token缓存
post:info:{postId}              # 帖子详情缓存
post:list:category:{categoryId} # 分类帖子列表缓存
post:hot:daily                  # 每日热门帖子
post:view:count:{postId}        # 帖子浏览量计数器
email:code:{email}:{type}       # 邮箱验证码缓存
api:limit:{ip}:{endpoint}       # API限流缓存


## 3. 后端架构设计

### 3.1 项目结构
deer-platform-backend/
├── src/main/java/com/deer/platform/
│   ├── DeerPlatformApplication.java
│   ├── config/                 # 配置类
│   │   ├── SecurityConfig.java
│   │   ├── RedisConfig.java
│   │   ├── SwaggerConfig.java
│   │   └── OssConfig.java
│   ├── controller/             # 控制器层
│   │   ├── AuthController.java
│   │   ├── UserController.java
│   │   ├── PostController.java
│   │   ├── CommentController.java
│   │   └── AdminController.java
│   ├── service/                # 服务层
│   │   ├── UserService.java
│   │   ├── PostService.java
│   │   ├── CommentService.java
│   │   ├── EmailService.java
│   │   └── FileService.java
│   ├── mapper/                 # 数据访问层
│   │   ├── UserMapper.java
│   │   ├── PostMapper.java
│   │   └── CommentMapper.java
│   ├── entity/                 # 实体类
│   │   ├── User.java
│   │   ├── Post.java
│   │   └── Comment.java
│   ├── dto/                    # 数据传输对象
│   │   ├── request/
│   │   └── response/
│   ├── common/                 # 公共组件
│   │   ├── result/
│   │   ├── exception/
│   │   ├── utils/
│   │   └── constants/
│   └── security/               # 安全相关
│       ├── JwtAuthenticationFilter.java
│       ├── JwtTokenProvider.java
│       └── UserDetailsServiceImpl.java
├── src/main/resources/
│   ├── application.yml
│   ├── application-dev.yml
│   ├── application-prod.yml
│   └── mapper/                 # MyBatis映射文件
└── pom.xml


### 3.2 核心配置文件

#### application.yml
```yaml
spring:
  profiles:
    active: dev
  application:
    name: deer-platform
  
  # 数据库配置
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/deer_platform?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:password}
    
  # Redis配置
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    database: 0
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0
        max-wait: -1ms
        
  # 邮件配置
  mail:
    host: smtp.qq.com
    port: 587
    username: ${MAIL_USERNAME}
    password: ${MAIL_PASSWORD}
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            
  # 文件上传配置
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 50MB

# MyBatis Plus配置
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: auto
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0

# JWT配置
jwt:
  secret: ${JWT_SECRET:deerPlatformSecretKey2024}
  expiration: 86400000  # 24小时
  
# 阿里云OSS配置
oss:
  endpoint: ${OSS_ENDPOINT}
  access-key-id: ${OSS_ACCESS_KEY_ID}
  access-key-secret: ${OSS_ACCESS_KEY_SECRET}
  bucket-name: ${OSS_BUCKET_NAME}
  
# 日志配置
logging:
  level:
    com.deer.platform: debug
    org.springframework.security: debug
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

### 3.3 核心代码实现

#### JWT认证配置
```java
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig {
    
    @Autowired
    private JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;
    
    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf().disable()
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/api/auth/**").permitAll()
                .requestMatchers("/api/posts/list", "/api/posts/{id}").permitAll()
                .requestMatchers("/api/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            )
            .exceptionHandling().authenticationEntryPoint(jwtAuthenticationEntryPoint)
            .and()
            .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
            
        return http.build();
    }
}
```

#### 用户服务实现
```java
@Service
@Transactional
public class UserServiceImpl implements UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private EmailService emailService;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Override
    public Result register(RegisterRequest request) {
        // 1. 验证邮箱验证码
        String cacheKey = "email:code:" + request.getEmail() + ":REGISTER";
        String cachedCode = (String) redisTemplate.opsForValue().get(cacheKey);
        if (!request.getCode().equals(cachedCode)) {
            return Result.error("验证码错误或已过期");
        }
        
        // 2. 检查邮箱是否已注册
        if (userMapper.existsByEmail(request.getEmail())) {
            return Result.error("邮箱已被注册");
        }
        
        // 3. 创建用户
        User user = new User();
        user.setEmail(request.getEmail());
        user.setPassword(passwordEncoder.encode(request.getPassword()));
        user.setNickname(request.getNickname());
        user.setStatus(UserStatus.ACTIVE);
        user.setEmailVerified(true);
        
        userMapper.insert(user);
        
        // 4. 删除验证码缓存
        redisTemplate.delete(cacheKey);
        
        return Result.success("注册成功");
    }
    
    @Override
    public Result sendEmailCode(String email, EmailCodeType type) {
        // 1. 生成6位随机验证码
        String code = RandomUtil.randomNumbers(6);
        
        // 2. 发送邮件
        emailService.sendVerificationCode(email, code, type);
        
        // 3. 缓存验证码(5分钟过期)
        String cacheKey = "email:code:" + email + ":" + type.name();
        redisTemplate.opsForValue().set(cacheKey, code, 5, TimeUnit.MINUTES);
        
        return Result.success("验证码已发送");
    }
}
```

## 4. 前端架构设计

### 4.1 项目结构 

deer-platform-frontend/
├── public/
│   ├── index.html
│   └── favicon.ico
├── src/
│   ├── main.js                 # 入口文件
│   ├── App.vue                 # 根组件
│   ├── router/                 # 路由配置
│   │   └── index.js
│   ├── store/                  # 状态管理
│   │   ├── index.js
│   │   ├── modules/
│   │   │   ├── user.js
│   │   │   ├── post.js
│   │   │   └── app.js
│   ├── views/                  # 页面组件
│   │   ├── Home.vue
│   │   ├── Login.vue
│   │   ├── Register.vue
│   │   ├── PostDetail.vue
│   │   ├── PostList.vue
│   │   ├── UserCenter.vue
│   │   └── Admin/
│   ├── components/             # 公共组件
│   │   ├── Header.vue
│   │   ├── Footer.vue
│   │   ├── PostCard.vue
│   │   ├── CommentList.vue
│   │   └── ImageUpload.vue
│   ├── api/                    # API接口
│   │   ├── auth.js
│   │   ├── user.js
│   │   ├── post.js
│   │   └── comment.js
│   ├── utils/                  # 工具函数
│   │   ├── request.js
│   │   ├── auth.js
│   │   ├── storage.js
│   │   └── validate.js
│   ├── styles/                 # 样式文件
│   │   ├── index.scss
│   │   ├── variables.scss
│   │   └── mixins.scss
│   └── assets/                 # 静态资源
├── package.json
├── vite.config.js
└── README.md

200: 成功
400: 请求参数错误
401: 未授权
403: 禁止访问
404: 资源不存在
500: 服务器内部错误

1001: 用户不存在
1002: 密码错误
1003: 账户被禁用
1004: 邮箱未验证

2001: 帖子不存在
2002: 帖子审核中
2003: 帖子已被删除

3001: 评论不存在
3002: 评论审核中


### 5.2 核心接口

#### 认证接口
```yaml
# 用户注册
POST /api/auth/register
Content-Type: application/json
{
  "email": "user@example.com",
  "password": "password123",
  "nickname": "用户昵称",
  "code": "123456"
}

# 用户登录
POST /api/auth/login
Content-Type: application/json
{
  "email": "user@example.com",
  "password": "password123"
}

# 发送邮箱验证码
POST /api/auth/send-code
Content-Type: application/json
{
  "email": "user@example.com",
  "type": "REGISTER"
}
```

#### 帖子接口
```yaml
# 获取帖子列表
GET /api/posts?category=1&page=1&size=10&sort=latest

# 获取帖子详情
GET /api/posts/{id}

# 发布帖子
POST /api/posts
Authorization: Bearer {token}
Content-Type: application/json
{
  "title": "帖子标题",
  "content": "帖子内容",
  "categoryId": 1,
  "tags": "标签1,标签2",
  "coverImage": "图片URL"
}

# 点赞帖子
POST /api/posts/{id}/like
Authorization: Bearer {token}

# 收藏帖子
POST /api/posts/{id}/collect
Authorization: Bearer {token}
```

## 6. 部署方案

### 6.1 Docker容器化

#### 后端Dockerfile
```dockerfile
FROM openjdk:11-jre-slim

VOLUME /tmp

COPY target/deer-platform-*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "/app.jar"]
```

#### 前端Dockerfile
```dockerfile
FROM node:16-alpine as builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### docker-compose.yml
```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: deer-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: deer_platform
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d
    
  redis:
    image: redis:7-alpine
    container_name: deer-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      
  backend:
    build: ./deer-platform-backend
    container_name: deer-backend
    ports:
      - "8080:8080"
    environment:
      DB_HOST: mysql
      REDIS_HOST: redis
    depends_on:
      - mysql
      - redis
      
  frontend:
    build: ./deer-platform-frontend
    container_name: deer-frontend
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mysql_data:
  redis_data:
```

### 6.2 CI/CD流程

#### GitHub Actions配置
```yaml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        
    - name: Build Backend
      run: |
        cd deer-platform-backend
        ./mvnw clean package -DskipTests
        
    - name: Build Frontend
      run: |
        cd deer-platform-frontend
        npm ci
        npm run build
        
    - name: Deploy to Server
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        script: |
          cd /opt/deer-platform
          git pull origin main
          docker-compose down
          docker-compose up -d --build
```

## 7. 监控与运维

### 7.1 应用监控

#### Prometheus配置
```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'deer-platform'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s
```

#### 关键指标监控
- **应用指标**: QPS、响应时间、错误率
- **系统指标**: CPU、内存、磁盘、网络
- **业务指标**: 用户注册量、帖子发布量、活跃用户数

### 7.2 日志管理

#### ELK Stack配置
```yaml
# logstash.conf
input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][service] == "deer-platform" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} \[%{DATA:thread}\] %{LOGLEVEL:level} %{DATA:logger} - %{GREEDYDATA:msg}" }
    }
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "deer-platform-%{+YYYY.MM.dd}"
  }
}
```

## 8. 安全方案

### 8.1 安全措施

1. **认证安全**
   - JWT Token认证
   - 密码BCrypt加密
   - 邮箱验证机制

2. **接口安全**
   - API限流(Redis + 注解)
   - 参数校验和SQL注入防护
   - XSS攻击防护

3. **数据安全**
   - 数据库连接加密
   - 敏感信息脱敏
   - 定期数据备份

### 8.2 限流实现

```java
@Component
public class RateLimitInterceptor implements HandlerInterceptor {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        String ip = getClientIP(request);
        String uri = request.getRequestURI();
        String key = "api:limit:" + ip + ":" + uri;
        
        // 每分钟最多60次请求
        Long count = redisTemplate.opsForValue().increment(key);
        if (count == 1) {
            redisTemplate.expire(key, 60, TimeUnit.SECONDS);
        }
        
        if (count > 60) {
            response.setStatus(429);
            response.getWriter().write("{\"code\":429,\"message\":\"请求过于频繁\"}");
            return false;
        }
        
        return true;
    }
}
```

## 9. 性能优化

### 9.1 数据库优化

1. **索引优化**
   - 为常用查询字段添加索引
   - 复合索引优化查询性能
   - 定期分析慢查询日志

2. **查询优化**
   - 分页查询优化
   - 避免N+1查询问题
   - 使用缓存减少数据库压力

### 9.2 缓存策略

1. **多级缓存**
   - 浏览器缓存(静态资源)
   - CDN缓存(图片、CSS、JS)
   - Redis缓存(热点数据)
   - 应用缓存(本地缓存)

2. **缓存更新策略**
   - 写入时更新缓存
   - 定时刷新缓存
   - 缓存穿透防护

## 10. 测试方案

### 10.1 测试策略

1. **单元测试**
   - Service层业务逻辑测试
   - 工具类方法测试
   - 覆盖率要求80%+

2. **集成测试**
   - API接口测试
   - 数据库操作测试
   - 第三方服务集成测试

3. **性能测试**
   - 压力测试(JMeter)
   - 并发测试
   - 数据库性能测试

### 10.2 测试用例示例

```java
@SpringBootTest
@Transactional
class UserServiceTest {
    
    @Autowired
    private UserService userService;
    
    @Test
    void testRegister_Success() {
        RegisterRequest request = new RegisterRequest();
        request.setEmail("test@example.com");
        request.setPassword("password123");
        request.setNickname("测试用户");
        request.setCode("123456");
        
        // Mock验证码缓存
        when(redisTemplate.opsForValue().get(anyString())).thenReturn("123456");
        
        Result result = userService.register(request);
        
        assertEquals(200, result.getCode());
        assertEquals("注册成功", result.getMessage());
    }
    
    @Test
    void testRegister_EmailExists() {
        // 测试邮箱已存在的情况
        RegisterRequest request = new RegisterRequest();
        request.setEmail("existing@example.com");
        
        when(userMapper.existsByEmail("existing@example.com")).thenReturn(true);
        
        Result result = userService.register(request);
        
        assertEquals(400, result.getCode());
        assertEquals("邮箱已被注册", result.getMessage());
    }
}
```

---

**文档版本**: v1.0  