<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†ç±»æµè§ˆ - æ—éºå…»æ®–äº¤æµåˆ†äº«å¹³å°</title>
    <link rel="stylesheet" href="css/category.css">
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="header">
        <div class="nav-container">
            <a href="index.html" class="logo">æ—éºå…»æ®–äº¤æµå¹³å°</a>
            <nav class="nav-menu" id="nav-menu">
                <a href="index.html">é¦–é¡µ</a>
                <!-- åŠ¨æ€åŠ è½½åˆ†ç±»å¯¼èˆª -->
            </nav>
            <div class="user-actions">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="æœç´¢å¸–å­...">
                    <button onclick="performSearch()">ğŸ”</button>
                </div>
                <div class="user-info" id="user-info">
                    <div class="login-buttons" id="login-buttons">
                        <a href="login.html" class="btn-login">ç™»å½•</a>
                        <a href="register.html" class="btn-register">æ³¨å†Œ</a>
                    </div>
                    <div class="user-profile" id="user-profile" style="display: none;">
                        <div class="avatar" id="user-avatar">ğŸ‘¤</div>
                        <span id="username">ç”¨æˆ·</span>
                        <div class="user-dropdown">
                            <a href="user-center.html">ä¸ªäººä¸­å¿ƒ</a>
                            <a href="create-post.html">å‘å¸ƒå¸–å­</a>
                            <a href="#" onclick="logout()">é€€å‡ºç™»å½•</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-container">
        <!-- å†…å®¹åŒºåŸŸ -->
        <main class="content-area">
            <!-- åˆ†ç±»å¤´éƒ¨ -->
            <div class="category-header">
                <h1 class="category-title" id="category-title">åˆ†ç±»æµè§ˆ</h1>
                <p class="category-description" id="category-description">æµè§ˆä¸åŒåˆ†ç±»ä¸‹çš„ç²¾å½©å†…å®¹</p>
                <div class="category-stats" id="category-stats">
                    <span>å…± <span id="total-posts">0</span> ç¯‡å¸–å­</span>
                </div>
            </div>

            <!-- ç­›é€‰æ  -->
            <div class="filter-bar">
                <div class="filter-options">
                    <select class="filter-select" id="sortSelect">
                        <option value="createdAt,desc">æœ€æ–°å‘å¸ƒ</option>
                        <option value="viewCount,desc">æµè§ˆæœ€å¤š</option>
                        <option value="likeCount,desc">ç‚¹èµæœ€å¤š</option>
                        <option value="commentCount,desc">è¯„è®ºæœ€å¤š</option>
                        <option value="createdAt,asc">æœ€æ—©å‘å¸ƒ</option>
                    </select>
                    <select class="filter-select" id="timeSelect">
                        <option value="all">å…¨éƒ¨æ—¶é—´</option>
                        <option value="today">ä»Šå¤©</option>
                        <option value="week">æœ¬å‘¨</option>
                        <option value="month">æœ¬æœˆ</option>
                        <option value="year">ä»Šå¹´</option>
                    </select>
                    <select class="filter-select" id="statusSelect">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="PUBLISHED">å·²å‘å¸ƒ</option>
                        <option value="PENDING">å¾…å®¡æ ¸</option>
                    </select>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="list">ğŸ“‹ åˆ—è¡¨</button>
                    <button class="view-btn" data-view="grid">âŠ ç½‘æ ¼</button>
                </div>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading" style="text-align: center; padding: 2rem; display: none;">
                <p>åŠ è½½ä¸­...</p>
            </div>

            <!-- å¸–å­åˆ—è¡¨ -->
            <div class="post-list" id="postList">
                <!-- åŠ¨æ€åŠ è½½å¸–å­å†…å®¹ -->
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div id="empty-state" style="text-align: center; padding: 3rem; color: #666; display: none;">
                <h3>æš‚æ— å¸–å­</h3>
                <p>è¯¥åˆ†ç±»ä¸‹è¿˜æ²¡æœ‰å¸–å­ï¼Œ<a href="create-post.html">å‘å¸ƒç¬¬ä¸€ç¯‡</a>å§ï¼</p>
            </div>
            


            <!-- åˆ†é¡µ -->
            <div class="pagination" id="pagination" style="display: none;">
                <!-- åŠ¨æ€ç”Ÿæˆåˆ†é¡µæŒ‰é’® -->
            </div>
        </main>

        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <!-- çƒ­é—¨æ ‡ç­¾ -->
            <div class="sidebar-widget">
                <div class="widget-header">çƒ­é—¨æ ‡ç­¾</div>
                <div class="widget-content">
                    <div class="tag-list" id="hot-tags">
                        <!-- åŠ¨æ€åŠ è½½çƒ­é—¨æ ‡ç­¾ -->
                    </div>
                </div>
            </div>

            <!-- çƒ­é—¨å¸–å­ -->
            <div class="sidebar-widget">
                <div class="widget-header">çƒ­é—¨å¸–å­</div>
                <div class="widget-content">
                    <ul class="hot-posts" id="hot-posts">
                        <!-- åŠ¨æ€åŠ è½½çƒ­é—¨å¸–å­ -->
                    </ul>
                </div>
            </div>

            <!-- åˆ†ç±»å¯¼èˆª -->
            <div class="sidebar-widget">
                <div class="widget-header">åˆ†ç±»å¯¼èˆª</div>
                <div class="widget-content">
                    <div class="tag-list" id="category-nav">
                        <!-- åŠ¨æ€åŠ è½½åˆ†ç±»å¯¼èˆª -->
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="sidebar-widget">
                <div class="widget-header">ç»Ÿè®¡ä¿¡æ¯</div>
                <div class="widget-content">
                    <div class="stats-list">
                        <div class="stat-item">
                            <span class="stat-label">æ€»å¸–å­æ•°</span>
                            <span class="stat-value" id="total-posts-stat">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ä»Šæ—¥æ–°å¢</span>
                            <span class="stat-value" id="today-posts-stat">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æœ¬å‘¨æ–°å¢</span>
                            <span class="stat-value" id="week-posts-stat">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script src="js/config.js"></script>
    <script>
        let currentCategory = null;
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 0;
        let isLoading = false;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            checkLoginStatus();
            bindEvents();
            await loadCategories();
            setCategoryFromURL();
        });

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç­›é€‰å’Œæ’åºäº‹ä»¶
            document.getElementById('sortSelect').addEventListener('change', () => {
                currentPage = 1;
                loadPosts();
            });
            
            document.getElementById('timeSelect').addEventListener('change', () => {
                currentPage = 1;
                loadPosts();
            });
            
            document.getElementById('statusSelect').addEventListener('change', () => {
                currentPage = 1;
                loadPosts();
            });

            // è§†å›¾åˆ‡æ¢
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    toggleView(this.dataset.view);
                });
            });

            // æœç´¢åŠŸèƒ½
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            
            if (token && username) {
                document.getElementById('login-buttons').style.display = 'none';
                document.getElementById('user-profile').style.display = 'flex';
                document.getElementById('username').textContent = username;
            } else {
                document.getElementById('login-buttons').style.display = 'flex';
                document.getElementById('user-profile').style.display = 'none';
            }
        }

        // åŠ è½½åˆ†ç±»åˆ—è¡¨
        async function loadCategories() {
            try {
                const response = await categoryAPI.getAll();
                if (response.success) {
                    displayCategories(response.data);
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºåˆ†ç±»å¯¼èˆª
        function displayCategories(categories) {
            const navMenu = document.getElementById('nav-menu');
            const categoryNav = document.getElementById('category-nav');
            
            // æ›´æ–°é¡¶éƒ¨å¯¼èˆª
            const categoryLinks = categories.map(cat => 
                `<a href="category.html?cat=${cat.id}" data-category="${cat.id}">${escapeHtml(cat.name)}</a>`
            ).join('');
            navMenu.innerHTML = `<a href="index.html">é¦–é¡µ</a>${categoryLinks}`;
            
            // æ›´æ–°ä¾§è¾¹æ åˆ†ç±»å¯¼èˆª
            const categoryTags = categories.map(cat => 
                `<a href="category.html?cat=${cat.id}" class="tag" data-category="${cat.id}">${escapeHtml(cat.name)}</a>`
            ).join('');
            categoryNav.innerHTML = categoryTags;
        }

        // æ ¹æ®URLå‚æ•°è®¾ç½®åˆ†ç±»
        function setCategoryFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            // å…¼å®¹ä¸¤ç§å‚æ•°åï¼šid å’Œ cat
            const categoryId = urlParams.get('id') || urlParams.get('cat');
            
            if (categoryId) {
                currentCategory = categoryId;
                loadCategoryInfo(categoryId);
                updateActiveNavigation(categoryId);
            } else {
                // æ˜¾ç¤ºæ‰€æœ‰åˆ†ç±»çš„å¸–å­
                currentCategory = null;
                document.getElementById('category-title').textContent = 'å…¨éƒ¨å¸–å­';
                document.getElementById('category-description').textContent = 'æµè§ˆæ‰€æœ‰åˆ†ç±»ä¸‹çš„ç²¾å½©å†…å®¹';
            }
            
            loadPosts();
            loadHotPosts();
            loadHotTags();
            loadStats();
        }

        // åŠ è½½åˆ†ç±»ä¿¡æ¯
        async function loadCategoryInfo(categoryId) {
            try {
                const response = await categoryAPI.getById(categoryId);
                if (response.success) {
                    const category = response.data;
                    document.getElementById('category-title').textContent = category.name;
                    document.getElementById('category-description').textContent = category.description || 'æµè§ˆè¯¥åˆ†ç±»ä¸‹çš„ç²¾å½©å†…å®¹';
                    document.title = `${category.name} - æ—éºå…»æ®–äº¤æµåˆ†äº«å¹³å°`;
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // æ›´æ–°å¯¼èˆªæ¿€æ´»çŠ¶æ€
        function updateActiveNavigation(categoryId) {
            document.querySelectorAll('.nav-menu a, .tag-list a').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.category === categoryId) {
                    link.classList.add('active');
                }
            });
        }

        // åŠ è½½å¸–å­åˆ—è¡¨
        async function loadPosts() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            
            try {
                const sortValue = document.getElementById('sortSelect').value;
                const timeRange = document.getElementById('timeSelect').value;
                const status = document.getElementById('statusSelect').value;
                
                const [sortField, sortOrder] = sortValue.split(',');
                
                const params = {
                    page: currentPage - 1, // åç«¯åˆ†é¡µä»0å¼€å§‹
                    size: pageSize,
                    sortBy: sortField,
                    sortOrder: sortOrder
                };
                
                if (currentCategory) {
                    params.categoryId = currentCategory;
                }
                
                if (status !== 'all') {
                    params.status = status;
                }
                
                if (timeRange !== 'all') {
                    params.timeRange = timeRange;
                }
                
                const response = await postAPI.getList(params);
                
                if (response.success) {
                    // åç«¯è¿”å›çš„æ•°æ®ç»“æ„ï¼šresponse.data.content æ˜¯å¸–å­æ•°ç»„
                    const posts = response.data.content || [];
                    const totalElements = response.data.totalElements || 0;
                    const totalPages = response.data.totalPages || 0;
                    const backendCurrentPage = response.data.number || 0;

                    displayPosts(posts);
                    updatePagination(backendCurrentPage + 1, totalPages, totalElements); // è½¬æ¢ä¸ºå‰ç«¯é¡µç 
                    document.getElementById('total-posts').textContent = totalElements;
                } else {
                    showError('åŠ è½½å¸–å­å¤±è´¥: ' + response.message);
                }
            } catch (error) {
                console.error('åŠ è½½å¸–å­å¤±è´¥:', error);
                showError('åŠ è½½å¸–å­å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                isLoading = false;
                showLoading(false);
            }
        }

        // æ˜¾ç¤ºå¸–å­åˆ—è¡¨
        function displayPosts(posts) {
            const postList = document.getElementById('postList');
            const emptyState = document.getElementById('empty-state');
            
            if (posts.length === 0) {
                postList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            postList.innerHTML = posts.map(post => `
                <article class="post-item">
                    <div class="post-thumbnail ${post.coverImage ? '' : 'no-image'}">
                        ${post.coverImage ? 
                            `<img src="${post.coverImage}" alt="${escapeHtml(post.title)}" onerror="this.parentElement.innerHTML='ğŸ“';">` : 
                            'ğŸ“'
                        }
                    </div>
                    <div class="post-content">
                        <h3 class="post-title">
                            <a href="post-detail.html?id=${post.id}">${escapeHtml(post.title)}</a>
                        </h3>
                        <p class="post-excerpt">
                            ${escapeHtml(post.summary || post.content.substring(0, 150) + '...')}
                        </p>
                        <div class="post-meta">
                            <div class="post-author">
                                <span>ğŸ‘¤</span>
                                <span>${escapeHtml(post.author?.nickname || post.author?.username || 'åŒ¿åç”¨æˆ·')}</span>
                            </div>
                            <span>${formatDate(post.createdAt)}</span>
                            <span class="post-category">${escapeHtml(post.category?.name || 'æœªåˆ†ç±»')}</span>
                            <div class="post-stats">
                                <div class="stat-item">
                                    <span>ğŸ‘</span>
                                    <span>${post.viewCount || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span>ğŸ’¬</span>
                                    <span>${post.commentCount || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span>ğŸ‘</span>
                                    <span>${post.likeCount || 0}</span>
                                </div>
                            </div>
                            ${post.status !== 'PUBLISHED' ? `<span class="post-status status-${post.status.toLowerCase()}">${getPostStatusText(post.status)}</span>` : ''}
                        </div>
                    </div>
                </article>
            `).join('');
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination(current, total, totalCount) {
            currentPage = current;
            totalPages = total;
            
            const pagination = document.getElementById('pagination');
            
            if (total <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            let paginationHTML = '';
            
            // ä¸Šä¸€é¡µ
            paginationHTML += `<a href="#" class="page-btn ${current === 1 ? 'disabled' : ''}" onclick="changePage(${current - 1})" ${current === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</a>`;
            
            // é¡µç 
            const startPage = Math.max(1, current - 2);
            const endPage = Math.min(total, current + 2);
            
            if (startPage > 1) {
                paginationHTML += `<a href="#" class="page-btn" onclick="changePage(1)">1</a>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="page-ellipsis">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<a href="#" class="page-btn ${i === current ? 'active' : ''}" onclick="changePage(${i})">${i}</a>`;
            }
            
            if (endPage < total) {
                if (endPage < total - 1) {
                    paginationHTML += `<span class="page-ellipsis">...</span>`;
                }
                paginationHTML += `<a href="#" class="page-btn" onclick="changePage(${total})">${total}</a>`;
            }
            
            // ä¸‹ä¸€é¡µ
            paginationHTML += `<a href="#" class="page-btn ${current === total ? 'disabled' : ''}" onclick="changePage(${current + 1})" ${current === total ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</a>`;
            
            pagination.innerHTML = paginationHTML;
        }

        // åˆ‡æ¢é¡µé¢
        function changePage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            loadPosts();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // åŠ è½½çƒ­é—¨å¸–å­
        async function loadHotPosts() {
            try {
                const response = await postAPI.getList({
                    page: 1,
                    size: 5,
                    sortBy: 'viewCount',
                    sortOrder: 'desc',
                    status: 'PUBLISHED'
                });
                
                if (response.success) {
                    // ä½¿ç”¨æ­£ç¡®çš„æ•°æ®ç»“æ„
                    const posts = response.data.content || [];
                    displayHotPosts(posts);
                }
            } catch (error) {
                console.error('åŠ è½½çƒ­é—¨å¸–å­å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºçƒ­é—¨å¸–å­
        function displayHotPosts(posts) {
            const hotPosts = document.getElementById('hot-posts');
            
            hotPosts.innerHTML = posts.map(post => `
                <li class="hot-post">
                    <a href="post-detail.html?id=${post.id}">${escapeHtml(post.title)}</a>
                    <div class="hot-post-meta">ğŸ‘ ${post.viewCount || 0} | ğŸ’¬ ${post.commentCount || 0}</div>
                </li>
            `).join('');
        }

        // åŠ è½½çƒ­é—¨æ ‡ç­¾
        async function loadHotTags() {
            // è¿™é‡Œå¯ä»¥å®ç°çƒ­é—¨æ ‡ç­¾çš„APIè°ƒç”¨
            // æš‚æ—¶ä½¿ç”¨é™æ€æ•°æ®
            const hotTags = ['å¹¼å´½é¥²å…»', 'ç–¾ç—…é¢„é˜²', 'é¥²æ–™é…æ–¹', 'åœºåœ°å»ºè®¾', 'ç¯å¢ƒæ§åˆ¶', 'ç¹æ®–æŠ€æœ¯', 'æˆæœ¬æ§åˆ¶', 'å¸‚åœºè¡Œæƒ…'];
            
            const hotTagsElement = document.getElementById('hot-tags');
            hotTagsElement.innerHTML = hotTags.map(tag => 
                `<a href="#" class="tag" onclick="searchByTag('${tag}')">${tag}</a>`
            ).join('');
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                // è¿™é‡Œå¯ä»¥å®ç°ç»Ÿè®¡ä¿¡æ¯çš„APIè°ƒç”¨
                // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                document.getElementById('total-posts-stat').textContent = '0';
                document.getElementById('today-posts-stat').textContent = '0';
                document.getElementById('week-posts-stat').textContent = '0';
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢è§†å›¾
        function toggleView(view) {
            const postList = document.getElementById('postList');
            
            if (view === 'grid') {
                postList.classList.add('grid-view');
            } else {
                postList.classList.remove('grid-view');
            }
        }

        // æ‰§è¡Œæœç´¢
        function performSearch() {
            const keyword = document.getElementById('search-input').value.trim();
            if (keyword) {
                window.location.href = `index.html?search=${encodeURIComponent(keyword)}`;
            }
        }

        // æŒ‰æ ‡ç­¾æœç´¢
        function searchByTag(tag) {
            window.location.href = `index.html?search=${encodeURIComponent(tag)}`;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                localStorage.removeItem('userId');
                checkLoginStatus();
                window.location.reload();
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const postList = document.getElementById('postList');
            postList.innerHTML = `<div style="text-align: center; padding: 2rem; color: #dc3545;">${message}</div>`;
        }

        // å·¥å…·å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) {
                return 'åˆšåˆš';
            } else if (diff < 3600000) {
                return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            } else if (diff < 86400000) {
                return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            } else if (diff < 2592000000) {
                return Math.floor(diff / 86400000) + 'å¤©å‰';
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }

        function getPostStatusText(status) {
            const statusMap = {
                'PUBLISHED': 'å·²å‘å¸ƒ',
                'DRAFT': 'è‰ç¨¿',
                'PENDING': 'å¾…å®¡æ ¸',
                'REJECTED': 'å·²æ‹’ç»'
            };
            return statusMap[status] || 'æœªçŸ¥';
        }
        

    </script>
    <script src="js/api.js"></script>
</body>
</html>