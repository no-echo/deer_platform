<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分类浏览 - 林麝养殖交流分享平台</title>
    <link rel="stylesheet" href="css/category.css">
</head>
<body>
    <!-- 头部导航 -->
    <header class="header">
        <div class="nav-container">
            <a href="index.html" class="logo">林麝养殖交流平台</a>
            <nav class="nav-menu" id="nav-menu">
                <a href="index.html">首页</a>
                <!-- 动态加载分类导航 -->
            </nav>
            <div class="user-actions">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="搜索帖子...">
                    <button onclick="performSearch()">🔍</button>
                </div>
                <div class="user-info" id="user-info">
                    <div class="login-buttons" id="login-buttons">
                        <a href="login.html" class="btn-login">登录</a>
                        <a href="register.html" class="btn-register">注册</a>
                    </div>
                    <div class="user-profile" id="user-profile" style="display: none;">
                        <div class="avatar" id="user-avatar">👤</div>
                        <span id="username">用户</span>
                        <div class="user-dropdown">
                            <a href="user-center.html">个人中心</a>
                            <a href="create-post.html">发布帖子</a>
                            <a href="#" onclick="logout()">退出登录</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <div class="main-container">
        <!-- 内容区域 -->
        <main class="content-area">
            <!-- 分类头部 -->
            <div class="category-header">
                <h1 class="category-title" id="category-title">分类浏览</h1>
                <p class="category-description" id="category-description">浏览不同分类下的精彩内容</p>
                <div class="category-stats" id="category-stats">
                    <span>共 <span id="total-posts">0</span> 篇帖子</span>
                </div>
            </div>

            <!-- 筛选栏 -->
            <div class="filter-bar">
                <div class="filter-options">
                    <select class="filter-select" id="sortSelect">
                        <option value="createdAt,desc">最新发布</option>
                        <option value="viewCount,desc">浏览最多</option>
                        <option value="likeCount,desc">点赞最多</option>
                        <option value="commentCount,desc">评论最多</option>
                        <option value="createdAt,asc">最早发布</option>
                    </select>
                    <select class="filter-select" id="timeSelect">
                        <option value="all">全部时间</option>
                        <option value="today">今天</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                        <option value="year">今年</option>
                    </select>
                    <select class="filter-select" id="statusSelect">
                        <option value="all">全部状态</option>
                        <option value="PUBLISHED">已发布</option>
                        <option value="PENDING">待审核</option>
                    </select>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="list">📋 列表</button>
                    <button class="view-btn" data-view="grid">⊞ 网格</button>
                </div>
            </div>

            <!-- 加载状态 -->
            <div id="loading" style="text-align: center; padding: 2rem; display: none;">
                <p>加载中...</p>
            </div>

            <!-- 帖子列表 -->
            <div class="post-list" id="postList">
                <!-- 动态加载帖子内容 -->
            </div>

            <!-- 空状态 -->
            <div id="empty-state" style="text-align: center; padding: 3rem; color: #666; display: none;">
                <h3>暂无帖子</h3>
                <p>该分类下还没有帖子，<a href="create-post.html">发布第一篇</a>吧！</p>
            </div>
            


            <!-- 分页 -->
            <div class="pagination" id="pagination" style="display: none;">
                <!-- 动态生成分页按钮 -->
            </div>
        </main>

        <!-- 侧边栏 -->
        <aside class="sidebar">
            <!-- 热门标签 -->
            <div class="sidebar-widget">
                <div class="widget-header">热门标签</div>
                <div class="widget-content">
                    <div class="tag-list" id="hot-tags">
                        <!-- 动态加载热门标签 -->
                    </div>
                </div>
            </div>

            <!-- 热门帖子 -->
            <div class="sidebar-widget">
                <div class="widget-header">热门帖子</div>
                <div class="widget-content">
                    <ul class="hot-posts" id="hot-posts">
                        <!-- 动态加载热门帖子 -->
                    </ul>
                </div>
            </div>

            <!-- 分类导航 -->
            <div class="sidebar-widget">
                <div class="widget-header">分类导航</div>
                <div class="widget-content">
                    <div class="tag-list" id="category-nav">
                        <!-- 动态加载分类导航 -->
                    </div>
                </div>
            </div>

            <!-- 统计信息 -->
            <div class="sidebar-widget">
                <div class="widget-header">统计信息</div>
                <div class="widget-content">
                    <div class="stats-list">
                        <div class="stat-item">
                            <span class="stat-label">总帖子数</span>
                            <span class="stat-value" id="total-posts-stat">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">今日新增</span>
                            <span class="stat-value" id="today-posts-stat">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">本周新增</span>
                            <span class="stat-value" id="week-posts-stat">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script src="js/config.js"></script>
    <script>
        let currentCategory = null;
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 0;
        let isLoading = false;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async function() {
            checkLoginStatus();
            bindEvents();
            await loadCategories();
            setCategoryFromURL();
        });

        // 绑定事件
        function bindEvents() {
            // 筛选和排序事件
            document.getElementById('sortSelect').addEventListener('change', () => {
                currentPage = 1;
                loadPosts();
            });
            
            document.getElementById('timeSelect').addEventListener('change', () => {
                currentPage = 1;
                loadPosts();
            });
            
            document.getElementById('statusSelect').addEventListener('change', () => {
                currentPage = 1;
                loadPosts();
            });

            // 视图切换
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    toggleView(this.dataset.view);
                });
            });

            // 搜索功能
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }

        // 检查登录状态
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            
            if (token && username) {
                document.getElementById('login-buttons').style.display = 'none';
                document.getElementById('user-profile').style.display = 'flex';
                document.getElementById('username').textContent = username;
            } else {
                document.getElementById('login-buttons').style.display = 'flex';
                document.getElementById('user-profile').style.display = 'none';
            }
        }

        // 加载分类列表
        async function loadCategories() {
            try {
                const response = await categoryAPI.getAll();
                if (response.success) {
                    displayCategories(response.data);
                }
            } catch (error) {
                console.error('加载分类失败:', error);
            }
        }

        // 显示分类导航
        function displayCategories(categories) {
            const navMenu = document.getElementById('nav-menu');
            const categoryNav = document.getElementById('category-nav');
            
            // 更新顶部导航
            const categoryLinks = categories.map(cat => 
                `<a href="category.html?cat=${cat.id}" data-category="${cat.id}">${escapeHtml(cat.name)}</a>`
            ).join('');
            navMenu.innerHTML = `<a href="index.html">首页</a>${categoryLinks}`;
            
            // 更新侧边栏分类导航
            const categoryTags = categories.map(cat => 
                `<a href="category.html?cat=${cat.id}" class="tag" data-category="${cat.id}">${escapeHtml(cat.name)}</a>`
            ).join('');
            categoryNav.innerHTML = categoryTags;
        }

        // 根据URL参数设置分类
        function setCategoryFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            // 兼容两种参数名：id 和 cat
            const categoryId = urlParams.get('id') || urlParams.get('cat');
            
            if (categoryId) {
                currentCategory = categoryId;
                loadCategoryInfo(categoryId);
                updateActiveNavigation(categoryId);
            } else {
                // 显示所有分类的帖子
                currentCategory = null;
                document.getElementById('category-title').textContent = '全部帖子';
                document.getElementById('category-description').textContent = '浏览所有分类下的精彩内容';
            }
            
            loadPosts();
            loadHotPosts();
            loadHotTags();
            loadStats();
        }

        // 加载分类信息
        async function loadCategoryInfo(categoryId) {
            try {
                const response = await categoryAPI.getById(categoryId);
                if (response.success) {
                    const category = response.data;
                    document.getElementById('category-title').textContent = category.name;
                    document.getElementById('category-description').textContent = category.description || '浏览该分类下的精彩内容';
                    document.title = `${category.name} - 林麝养殖交流分享平台`;
                }
            } catch (error) {
                console.error('加载分类信息失败:', error);
            }
        }

        // 更新导航激活状态
        function updateActiveNavigation(categoryId) {
            document.querySelectorAll('.nav-menu a, .tag-list a').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.category === categoryId) {
                    link.classList.add('active');
                }
            });
        }

        // 加载帖子列表
        async function loadPosts() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            
            try {
                const sortValue = document.getElementById('sortSelect').value;
                const timeRange = document.getElementById('timeSelect').value;
                const status = document.getElementById('statusSelect').value;
                
                const [sortField, sortOrder] = sortValue.split(',');
                
                const params = {
                    page: currentPage - 1, // 后端分页从0开始
                    size: pageSize,
                    sortBy: sortField,
                    sortOrder: sortOrder
                };
                
                if (currentCategory) {
                    params.categoryId = currentCategory;
                }
                
                if (status !== 'all') {
                    params.status = status;
                }
                
                if (timeRange !== 'all') {
                    params.timeRange = timeRange;
                }
                
                const response = await postAPI.getList(params);
                
                if (response.success) {
                    // 后端返回的数据结构：response.data.content 是帖子数组
                    const posts = response.data.content || [];
                    const totalElements = response.data.totalElements || 0;
                    const totalPages = response.data.totalPages || 0;
                    const backendCurrentPage = response.data.number || 0;

                    displayPosts(posts);
                    updatePagination(backendCurrentPage + 1, totalPages, totalElements); // 转换为前端页码
                    document.getElementById('total-posts').textContent = totalElements;
                } else {
                    showError('加载帖子失败: ' + response.message);
                }
            } catch (error) {
                console.error('加载帖子失败:', error);
                showError('加载帖子失败，请稍后重试');
            } finally {
                isLoading = false;
                showLoading(false);
            }
        }

        // 显示帖子列表
        function displayPosts(posts) {
            const postList = document.getElementById('postList');
            const emptyState = document.getElementById('empty-state');
            
            if (posts.length === 0) {
                postList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            postList.innerHTML = posts.map(post => `
                <article class="post-item">
                    <div class="post-thumbnail ${post.coverImage ? '' : 'no-image'}">
                        ${post.coverImage ? 
                            `<img src="${post.coverImage}" alt="${escapeHtml(post.title)}" onerror="this.parentElement.innerHTML='📝';">` : 
                            '📝'
                        }
                    </div>
                    <div class="post-content">
                        <h3 class="post-title">
                            <a href="post-detail.html?id=${post.id}">${escapeHtml(post.title)}</a>
                        </h3>
                        <p class="post-excerpt">
                            ${escapeHtml(post.summary || post.content.substring(0, 150) + '...')}
                        </p>
                        <div class="post-meta">
                            <div class="post-author">
                                <span>👤</span>
                                <span>${escapeHtml(post.author?.nickname || post.author?.username || '匿名用户')}</span>
                            </div>
                            <span>${formatDate(post.createdAt)}</span>
                            <span class="post-category">${escapeHtml(post.category?.name || '未分类')}</span>
                            <div class="post-stats">
                                <div class="stat-item">
                                    <span>👁</span>
                                    <span>${post.viewCount || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span>💬</span>
                                    <span>${post.commentCount || 0}</span>
                                </div>
                                <div class="stat-item">
                                    <span>👍</span>
                                    <span>${post.likeCount || 0}</span>
                                </div>
                            </div>
                            ${post.status !== 'PUBLISHED' ? `<span class="post-status status-${post.status.toLowerCase()}">${getPostStatusText(post.status)}</span>` : ''}
                        </div>
                    </div>
                </article>
            `).join('');
        }

        // 更新分页
        function updatePagination(current, total, totalCount) {
            currentPage = current;
            totalPages = total;
            
            const pagination = document.getElementById('pagination');
            
            if (total <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            let paginationHTML = '';
            
            // 上一页
            paginationHTML += `<a href="#" class="page-btn ${current === 1 ? 'disabled' : ''}" onclick="changePage(${current - 1})" ${current === 1 ? 'disabled' : ''}>上一页</a>`;
            
            // 页码
            const startPage = Math.max(1, current - 2);
            const endPage = Math.min(total, current + 2);
            
            if (startPage > 1) {
                paginationHTML += `<a href="#" class="page-btn" onclick="changePage(1)">1</a>`;
                if (startPage > 2) {
                    paginationHTML += `<span class="page-ellipsis">...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<a href="#" class="page-btn ${i === current ? 'active' : ''}" onclick="changePage(${i})">${i}</a>`;
            }
            
            if (endPage < total) {
                if (endPage < total - 1) {
                    paginationHTML += `<span class="page-ellipsis">...</span>`;
                }
                paginationHTML += `<a href="#" class="page-btn" onclick="changePage(${total})">${total}</a>`;
            }
            
            // 下一页
            paginationHTML += `<a href="#" class="page-btn ${current === total ? 'disabled' : ''}" onclick="changePage(${current + 1})" ${current === total ? 'disabled' : ''}>下一页</a>`;
            
            pagination.innerHTML = paginationHTML;
        }

        // 切换页面
        function changePage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            loadPosts();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 加载热门帖子
        async function loadHotPosts() {
            try {
                const response = await postAPI.getList({
                    page: 1,
                    size: 5,
                    sortBy: 'viewCount',
                    sortOrder: 'desc',
                    status: 'PUBLISHED'
                });
                
                if (response.success) {
                    // 使用正确的数据结构
                    const posts = response.data.content || [];
                    displayHotPosts(posts);
                }
            } catch (error) {
                console.error('加载热门帖子失败:', error);
            }
        }

        // 显示热门帖子
        function displayHotPosts(posts) {
            const hotPosts = document.getElementById('hot-posts');
            
            hotPosts.innerHTML = posts.map(post => `
                <li class="hot-post">
                    <a href="post-detail.html?id=${post.id}">${escapeHtml(post.title)}</a>
                    <div class="hot-post-meta">👁 ${post.viewCount || 0} | 💬 ${post.commentCount || 0}</div>
                </li>
            `).join('');
        }

        // 加载热门标签
        async function loadHotTags() {
            // 这里可以实现热门标签的API调用
            // 暂时使用静态数据
            const hotTags = ['幼崽饲养', '疾病预防', '饲料配方', '场地建设', '环境控制', '繁殖技术', '成本控制', '市场行情'];
            
            const hotTagsElement = document.getElementById('hot-tags');
            hotTagsElement.innerHTML = hotTags.map(tag => 
                `<a href="#" class="tag" onclick="searchByTag('${tag}')">${tag}</a>`
            ).join('');
        }

        // 加载统计信息
        async function loadStats() {
            try {
                // 这里可以实现统计信息的API调用
                // 暂时使用模拟数据
                document.getElementById('total-posts-stat').textContent = '0';
                document.getElementById('today-posts-stat').textContent = '0';
                document.getElementById('week-posts-stat').textContent = '0';
            } catch (error) {
                console.error('加载统计信息失败:', error);
            }
        }

        // 切换视图
        function toggleView(view) {
            const postList = document.getElementById('postList');
            
            if (view === 'grid') {
                postList.classList.add('grid-view');
            } else {
                postList.classList.remove('grid-view');
            }
        }

        // 执行搜索
        function performSearch() {
            const keyword = document.getElementById('search-input').value.trim();
            if (keyword) {
                window.location.href = `index.html?search=${encodeURIComponent(keyword)}`;
            }
        }

        // 按标签搜索
        function searchByTag(tag) {
            window.location.href = `index.html?search=${encodeURIComponent(tag)}`;
        }

        // 退出登录
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                localStorage.removeItem('userId');
                checkLoginStatus();
                window.location.reload();
            }
        }

        // 显示加载状态
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // 显示错误信息
        function showError(message) {
            const postList = document.getElementById('postList');
            postList.innerHTML = `<div style="text-align: center; padding: 2rem; color: #dc3545;">${message}</div>`;
        }

        // 工具函数
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) {
                return '刚刚';
            } else if (diff < 3600000) {
                return Math.floor(diff / 60000) + '分钟前';
            } else if (diff < 86400000) {
                return Math.floor(diff / 3600000) + '小时前';
            } else if (diff < 2592000000) {
                return Math.floor(diff / 86400000) + '天前';
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }

        function getPostStatusText(status) {
            const statusMap = {
                'PUBLISHED': '已发布',
                'DRAFT': '草稿',
                'PENDING': '待审核',
                'REJECTED': '已拒绝'
            };
            return statusMap[status] || '未知';
        }
        

    </script>
    <script src="js/api.js"></script>
</body>
</html>